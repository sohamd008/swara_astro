---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
    const artists = await getCollection("artists");
    return artists.map((artist) => ({
        params: { slug: artist.slug },
        props: { artist },
    }));
}

const { artist } = Astro.props;
const { Content } = await artist.render();
const songs = artist.data.songs;
---

<Layout title={artist.data.name}>
    <div class="artist-detail-container">
        <!-- Artist Hero -->
        <div class="artist-hero">
            <div class="artist-header-info">
                <div class="artist-header-avatar">
                    <img
                        src={artist.data.image || "/logo.jpg"}
                        alt={artist.data.name}
                    />
                </div>
                <div class="artist-header-text">
                    <h1 class="hero-title">{artist.data.name}</h1>
                    <div class="artist-tags">
                        <span class="tag">Vocalist</span>
                        <span class="tag">Kirana Gharana</span>
                    </div>
                </div>
            </div>

            <div class="artist-bio-card glass">
                <h2>Biography</h2>
                <div class="bio-content">
                    <Content />
                </div>
            </div>
        </div>

        <!-- Songs Section -->
        <div class="songs-section">
            <h2 class="section-title">Musical <span>Treasury</span></h2>
            <div class="songs-list">
                {
                    songs.map((song, index) => (
                        <div class="song-item glass">
                            <div class="song-info">
                                <span class="song-index">{index + 1}</span>
                                <div class="song-meta">
                                    <span class="song-title">{song.title}</span>
                                    <span class="song-duration">
                                        {song.duration}
                                    </span>
                                </div>
                            </div>
                            <div class="song-actions">
                                <button
                                    class="play-btn"
                                    data-url={song.url}
                                    data-title={song.title}
                                    data-artist={artist.data.name}
                                >
                                    <svg
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="currentColor"
                                    >
                                        <path d="M8 5v14l11-7z" />
                                    </svg>
                                </button>
                                <button
                                    class="download-btn"
                                    data-url={song.url}
                                >
                                    <svg
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    ))
                }
            </div>
        </div>
    </div>
</Layout>

<script>
    import { playTrack, playCollection } from "../../lib/playerStore";
    import { userStart } from "../../lib/authStore";

    let currentUser: any = null;
    userStart.subscribe((user) => {
        currentUser = user;
        // Update UI state for download buttons
        const downloadBtns = document.querySelectorAll(".download-btn");
        downloadBtns.forEach((btn) => {
            if (user) {
                (btn as HTMLElement).style.opacity = "1";
                btn.setAttribute("title", "Download Composition");
                btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" /></svg>`;
            } else {
                (btn as HTMLElement).style.opacity = "0.6";
                btn.setAttribute("title", "Login to Download");
                // Optional: Change icon to lock
                btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
            }
        });
    });

    const artistName = (document.querySelector(".hero-title") as HTMLElement)
        ?.innerText;
    const songItems = Array.from(document.querySelectorAll(".play-btn")).map(
        (btn) => ({
            url: btn.getAttribute("data-url") || "",
            title: btn.getAttribute("data-title") || "",
            artist: artistName || "Unknown Artist",
        }),
    );

    const playBtns = document.querySelectorAll(".play-btn");
    playBtns.forEach((btn, index) => {
        btn.addEventListener("click", () => {
            playCollection(songItems, index);
        });
    });

    const downloadBtns = document.querySelectorAll(".download-btn");
    downloadBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
            if (!currentUser) {
                alert("Please login to download files.");
                window.location.href = "/login";
                return;
            }

            const url = btn.getAttribute("data-url");
            if (url) {
                try {
                    const link = document.createElement("a");
                    link.href = url;
                    // For GitHub/Remote files, target="_blank" is safer to ensure it doesn't navigate away
                    link.target = "_blank";
                    link.setAttribute("download", "");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (e) {
                    alert("Error initiating download: " + e);
                }
            }
        });
    });
</script>

<style>
    .artist-detail-container {
        width: 100%;
        max-width: 1000px;
        padding: 0 20px;
        display: flex;
        flex-direction: column;
        gap: 60px;
    }

    .artist-hero {
        display: flex;
        flex-direction: column;
        gap: 40px;
    }

    .artist-header-info {
        display: flex;
        align-items: center;
        gap: 32px;
    }

    @media (max-width: 768px) {
        .artist-header-info {
            flex-direction: column;
            text-align: center;
        }
    }

    .artist-header-avatar {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        overflow: hidden;
        border: 4px solid var(--accent-color);
        box-shadow: 0 10px 30px rgba(255, 45, 85, 0.4);
        flex-shrink: 0;
    }

    .artist-header-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .hero-title {
        font-size: 56px;
        margin: 0;
    }

    .artist-tags {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    @media (max-width: 768px) {
        .artist-tags {
            justify-content: center;
        }
    }

    .tag {
        padding: 6px 16px;
        background: var(--glass-fill);
        border: 1px solid var(--glass-border);
        border-radius: 15px;
        font-size: 14px;
        color: var(--text-secondary);
    }

    .artist-bio-card {
        padding: 40px;
        border-radius: 32px;
        background: var(--glass-fill);
        border: 1px solid var(--glass-border);
    }

    .artist-bio-card h2 {
        font-size: 32px;
        margin-bottom: 24px;
        color: var(--text-primary);
    }

    .bio-content {
        font-size: 18px;
        line-height: 1.7;
        color: var(--text-secondary);
    }

    .songs-section {
        margin-bottom: 100px;
    }

    .section-title {
        font-size: 40px;
        margin-bottom: 32px;
    }

    .section-title span {
        color: var(--accent-color);
        font-family: "Dancing Script", cursive;
    }

    .songs-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .song-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 32px;
        border-radius: 20px;
        background: var(--glass-fill);
        border: 1px solid var(--glass-border);
        transition:
            transform 0.2s,
            background 0.2s;
    }

    .song-item:hover {
        transform: scale(1.01);
        background: rgba(255, 255, 255, 0.05);
    }

    .song-info {
        display: flex;
        align-items: center;
        gap: 24px;
    }

    .song-index {
        font-size: 20px;
        font-weight: 700;
        color: var(--accent-color);
        opacity: 0.5;
        width: 30px;
    }

    .song-meta {
        display: flex;
        flex-direction: column;
    }

    .song-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .song-duration {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .song-actions {
        display: flex;
        gap: 16px;
    }

    .play-btn,
    .download-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--glass-border);
        background: var(--glass-fill);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .play-btn:hover {
        background: var(--accent-color);
        border-color: var(--accent-color);
        transform: scale(1.1);
    }

    .download-btn:hover {
        background: var(--text-primary);
        color: var(--bg-color);
        transform: scale(1.1);
    }

    @media (max-width: 768px) {
        .hero-title {
            font-size: 36px;
            text-align: center;
        }

        .artist-bio-card {
            padding: 24px;
        }

        .artist-bio-card h2 {
            font-size: 26px;
        }

        .bio-content {
            font-size: 16px;
        }

        .song-item {
            padding: 16px;
            gap: 12px;
        }

        .song-info {
            gap: 16px;
            flex: 1;
            min-width: 0; /* Enable truncation if needed */
        }

        .song-title {
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-actions {
            gap: 10px;
        }

        .play-btn,
        .download-btn {
            width: 36px;
            height: 36px;
        }
    }
</style>
