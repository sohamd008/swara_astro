---
// Player.astro - Robust Singleton & Liquid Glass UI
---

<div
    id="swara-player"
    class="swara-player glass-panel"
    style="display: none;"
    transition:persist
>
    <!-- Background Glow -->
    <div class="swara-glow"></div>

    <div class="swara-player-inner">
        <!-- Close Button -->
        <button
            id="swara-close"
            class="swara-close-btn"
            aria-label="Close Player"
        >
            <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>

        <!-- Layout Grid -->
        <div class="swara-layout">
            <!-- 1. Meta (Art + Info) -->
            <div class="swara-meta">
                <div class="swara-art-wrapper">
                    <img
                        src="/logo.jpg"
                        alt="Album Art"
                        id="swara-img"
                        class="swara-art"
                    />
                    <div id="swara-wave-anim" class="swara-wave-anim">
                        <span></span><span></span><span></span>
                    </div>
                </div>
                <div class="swara-info">
                    <h3 id="swara-title" class="swara-track-title">
                        Select a Track
                    </h3>
                    <p id="swara-artist" class="swara-track-artist">
                        Swaramanjusha
                    </p>
                </div>
            </div>

            <!-- 2. Controls (Central) -->
            <div class="swara-controls">
                <div class="swara-buttons">
                    <button
                        class="swara-btn"
                        id="swara-prev"
                        title="Previous"
                        aria-label="Previous Track"
                    >
                        <svg viewBox="0 0 24 24" fill="currentColor"
                            ><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></svg
                        >
                    </button>
                    <!-- Rewind 10s -->
                    <button
                        class="swara-btn swara-skip"
                        id="swara-rw"
                        title="Rewind 10s"
                        aria-label="Rewind 10 seconds"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"
                            ></path></svg
                        >
                    </button>

                    <button
                        class="swara-play-btn"
                        id="swara-toggle"
                        title="Play/Pause"
                        aria-label="Toggle Playback"
                    >
                        <!-- Play Icon -->
                        <svg
                            id="swara-icon-play"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path d="M8 5v14l11-7z"></path>
                        </svg>
                        <!-- Pause Icon -->
                        <svg
                            id="swara-icon-pause"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                            style="display: none;"
                        >
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
                        </svg>
                    </button>

                    <!-- Forward 10s -->
                    <button
                        class="swara-btn swara-skip"
                        id="swara-fw"
                        title="Forward 10s"
                        aria-label="Forward 10 seconds"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="M13 17l5-5-5-5M6 17l5-5-5-5"></path></svg
                        >
                    </button>
                    <button
                        class="swara-btn"
                        id="swara-next"
                        title="Next"
                        aria-label="Next Track"
                    >
                        <svg viewBox="0 0 24 24" fill="currentColor"
                            ><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"
                            ></path></svg
                        >
                    </button>
                </div>

                <div class="swara-progress-container">
                    <span id="swara-curr-time" class="swara-time">0:00</span>
                    <div id="swara-progress-bar" class="swara-progress-bar">
                        <div
                            id="swara-progress-fill"
                            class="swara-progress-fill"
                        >
                        </div>
                    </div>
                    <span id="swara-total-time" class="swara-time">0:00</span>
                </div>
            </div>

            <!-- 3. Volume (Right) -->
            <div class="swara-volume">
                <button class="swara-btn small" aria-label="Mute/Unmute">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"
                        ></path>
                    </svg>
                </button>
                <input
                    type="range"
                    id="swara-vol"
                    class="swara-range"
                    min="0"
                    max="1"
                    step="0.01"
                    value="0.8"
                    aria-label="Volume Slider"
                />
            </div>
        </div>
    </div>
</div>

<audio id="swara-audio" transition:persist></audio>

<script>
    import {
        isPlaying,
        currentTrack,
        volume,
        showPlayer,
        togglePlay,
        nextTrack,
        prevTrack,
        closePlayer,
    } from "../lib/playerStore";

    // SINGLETON PATTERN: Use a global flag to prevent double-initialization
    // persistent components stay in DOM, so we only need to init once.
    if (!(window as any)._swaraPlayerInitialized) {
        (window as any)._swaraPlayerInitialized = true;

        console.log("Initializing Swara Player (Singleton)...");

        const audio = document.getElementById(
            "swara-audio",
        ) as HTMLAudioElement;
        const playerContainer = document.getElementById("swara-player");

        // UI Refs
        const toggleBtn = document.getElementById("swara-toggle");
        const iconPlay = document.getElementById("swara-icon-play");
        const iconPause = document.getElementById("swara-icon-pause");
        const nextBtn = document.getElementById("swara-next");
        const prevBtn = document.getElementById("swara-prev");
        const rwBtn = document.getElementById("swara-rw");
        const fwBtn = document.getElementById("swara-fw");

        const titleEl = document.getElementById("swara-title");
        const artistEl = document.getElementById("swara-artist");
        const imgEl = document.getElementById("swara-img") as HTMLImageElement;
        const waveAnim = document.getElementById("swara-wave-anim");

        const progressBar = document.getElementById("swara-progress-bar");
        const progressFill = document.getElementById("swara-progress-fill");
        const currTimeEl = document.getElementById("swara-curr-time");
        const totalTimeEl = document.getElementById("swara-total-time");
        const volInput = document.getElementById(
            "swara-vol",
        ) as HTMLInputElement;
        const closeBtn = document.getElementById("swara-close");

        // Close Button
        closeBtn?.addEventListener("click", (e) => {
            e.stopPropagation();
            closePlayer();
        });

        // --- Store Subscriptions ---

        // 1. Visibility
        showPlayer.subscribe((visible) => {
            if (playerContainer) {
                // Ensure valid display value
                if (visible) {
                    playerContainer.style.display = "block";
                    // Small delay to allow display:block to apply before transition?
                    // But we just use standard display here for simplicity first.
                } else {
                    playerContainer.style.display = "none";
                }
            }
        });

        // 2. Track Updates
        currentTrack.subscribe((track: any) => {
            if (!track || !audio) return;

            // Only update src if different to prevent reloading
            if (audio.src !== track.url) {
                audio.src = track.url;
                // Autoplay on track change
                audio.play().catch((e) => console.warn("Autoplay blocked", e));
            }

            // Update UI
            if (titleEl) titleEl.innerText = track.title || "Unknown Title";
            if (artistEl) artistEl.innerText = track.artist || "Unknown Artist";
            if (imgEl) imgEl.src = track.image || "/logo.jpg";

            // Ensure visual state matches
            isPlaying.set(true);
        });

        // 3. Volume
        volume.subscribe((vol) => {
            if (audio) audio.volume = vol;
        });

        // 4. Play/Pause State
        isPlaying.subscribe((playing) => {
            if (!audio) return;

            if (playing) {
                audio.play().catch(() => {}); // handle promise
                if (iconPlay) iconPlay.style.display = "none";
                if (iconPause) iconPause.style.display = "block";
                if (waveAnim) waveAnim.style.opacity = "1";
            } else {
                audio.pause();
                if (iconPlay) iconPlay.style.display = "block";
                if (iconPause) iconPause.style.display = "none";
                if (waveAnim) waveAnim.style.opacity = "0";
            }
        });

        // --- Event Listeners (Bound ONCE) ---

        // Controls
        toggleBtn?.addEventListener("click", (e) => {
            e.stopPropagation();
            togglePlay();
        });

        nextBtn?.addEventListener("click", (e) => {
            e.stopPropagation();
            nextTrack();
        });
        prevBtn?.addEventListener("click", (e) => {
            e.stopPropagation();
            prevTrack();
        });

        rwBtn?.addEventListener("click", () => {
            if (audio) audio.currentTime -= 10;
        });
        fwBtn?.addEventListener("click", () => {
            if (audio) audio.currentTime += 10;
        });

        // Progress scrubbing
        progressBar?.addEventListener("click", (e) => {
            if (!audio) return;
            const rect = progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        });

        // Volume
        volInput?.addEventListener("input", (e) => {
            const val = parseFloat((e.target as HTMLInputElement).value);
            volume.set(val);
        });

        // Audio Internal Events (Sync back to store)
        if (audio) {
            audio.addEventListener("timeupdate", () => {
                if (!Number.isFinite(audio.duration)) return;

                const percent = (audio.currentTime / audio.duration) * 100;
                if (progressFill) progressFill.style.width = `${percent}%`;

                if (currTimeEl)
                    currTimeEl.innerText = formatTime(audio.currentTime);
                if (totalTimeEl)
                    totalTimeEl.innerText = formatTime(audio.duration);
            });

            audio.addEventListener("ended", () => {
                nextTrack();
            });

            // Native play/pause (e.g. keyboard keys) sync
            audio.addEventListener("play", () => isPlaying.set(true));
            audio.addEventListener("pause", () => isPlaying.set(false));
        }
    }

    function formatTime(seconds: number) {
        if (!seconds || isNaN(seconds)) return "0:00";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s.toString().padStart(2, "0")}`;
    }
</script>

<style>
    .glass-panel {
        background: rgba(20, 20, 25, 0.85);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        border-left: 1px solid rgba(255, 255, 255, 0.05);
        border-right: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
    }

    .swara-player {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 1000px;
        z-index: 9999;
        border-radius: 20px;
        overflow: hidden; /* Ensure contents clip to border radius */
    }

    .swara-glow {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 1px;
        background: linear-gradient(
            90deg,
            transparent,
            var(--accent-color, #ff4757),
            transparent
        );
        opacity: 0.5;
    }

    .swara-player-inner {
        max-width: 1200px;
        margin: 0 auto;
        padding: 12px 24px;
        position: relative;
    }

    .swara-close-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        cursor: pointer;
        padding: 4px;
        z-index: 10;
        border-radius: 50%;
        transition:
            color 0.2s,
            background 0.2s;
    }
    .swara-close-btn:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
    }
    .swara-close-btn svg {
        width: 18px;
        height: 18px;
    }

    .swara-layout {
        display: grid;
        grid-template-columns: 250px 1fr 200px; /* Meta - Controls - Volume */
        align-items: center;
        gap: 24px;
    }

    /* --- 1. Meta --- */
    .swara-meta {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .swara-art-wrapper {
        position: relative;
        width: 56px;
        height: 56px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
    }

    .swara-art {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .swara-info {
        min-width: 0; /* truncate text */
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .swara-track-title {
        color: #fff;
        font-size: 15px;
        font-weight: 600;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .swara-track-artist {
        color: rgba(255, 255, 255, 0.6);
        font-size: 13px;
        margin: 2px 0 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Wave Animation */
    .swara-wave-anim {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 3px;
        padding-bottom: 8px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .swara-wave-anim span {
        width: 3px;
        background: var(--accent-color, #ff4757);
        animation: wave 1s infinite ease-in-out;
        border-radius: 2px;
    }
    .swara-wave-anim span:nth-child(1) {
        height: 40%;
        animation-delay: 0.1s;
    }
    .swara-wave-anim span:nth-child(2) {
        height: 80%;
        animation-delay: 0.2s;
    }
    .swara-wave-anim span:nth-child(3) {
        height: 50%;
        animation-delay: 0.3s;
    }

    @keyframes wave {
        0%,
        100% {
            transform: scaleY(0.5);
        }
        50% {
            transform: scaleY(1);
        }
    }

    /* --- 2. Controls --- */
    .swara-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
    }

    .swara-buttons {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .swara-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        padding: 5px;
        transition: color 0.2s;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .swara-btn:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
    }
    .swara-btn svg {
        width: 24px;
        height: 24px;
    }
    .swara-skip svg {
        width: 20px;
        height: 20px;
    }

    .swara-play-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #fff;
        color: #000;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
    }
    .swara-play-btn:hover {
        transform: scale(1.05);
    }
    .swara-play-btn svg {
        width: 26px;
        height: 26px;
    }

    /* Progress */
    .swara-progress-container {
        width: 100%;
        max-width: 500px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .swara-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
        font-variant-numeric: tabular-nums;
        min-width: 32px;
    }

    .swara-progress-bar {
        flex: 1;
        height: 4px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 2px;
        cursor: pointer;
        position: relative;
    }
    .swara-progress-fill {
        height: 100%;
        background: var(--accent-color, #ff4757);
        width: 0%;
        border-radius: 2px;
        position: relative;
    }
    .swara-progress-fill::after {
        content: "";
        position: absolute;
        right: -4px;
        top: 50%;
        transform: translateY(-50%) scale(0);
        width: 10px;
        height: 10px;
        background: #fff;
        border-radius: 50%;
        transition: transform 0.1s;
    }
    .swara-progress-bar:hover .swara-progress-fill::after {
        transform: translateY(-50%) scale(1);
    }

    /* --- 3. Volume --- */
    .swara-volume {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
    }

    .swara-range {
        -webkit-appearance: none;
        width: 80px;
        height: 4px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 2px;
        outline: none;
    }
    .swara-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        background: #fff;
        border-radius: 50%;
        cursor: pointer;
    }

    /* --- Mobile --- */
    @media (max-width: 768px) {
        .swara-layout {
            grid-template-columns: 1fr auto; /* Title | PlayBtn */
            gap: 12px;
            padding: 4px 0;
        }

        .swara-meta {
            flex: 1;
            align-items: center;
        }

        .swara-art-wrapper {
            width: 42px;
            height: 42px;
        }

        /* Hide complicated controls on mobile default view */
        .swara-controls {
            flex-direction: row;
            width: auto;
        }

        .swara-skip {
            display: none;
        }

        /* Show needed controls */
        .swara-volume,
        #swara-prev,
        #swara-next,
        .swara-progress-container {
            display: flex;
        }

        /* Show only Play button on the right */
        .swara-buttons {
            gap: 0;
        }
        .swara-play-btn {
            width: 40px;
            height: 40px;
        }

        /* If we want full controls, we'd need an expand interaction. 
           For now, let's keep it simple bar. */
    }

    .swara-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        gap: 12px;
        padding: 8px 4px;
    }

    .swara-buttons {
        justify-content: center;
    }

    .swara-volume {
        width: 100%;
        justify-content: center;
    }
</style>
